{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"PVE-QEMU-VirtIO-Updater Documentation","text":"<p>This tool automatically monitors Windows VMs running on Proxmox VE for outdated VirtIO drivers and QEMU Guest Agent software, creating visual update notifications in the Proxmox UI.</p>"},{"location":"#quick-start","title":"Quick Start","text":"<ol> <li>Installation \u2013 Get the tool running in 5 minutes</li> <li>Configuration \u2013 Set up logging, notifications, scheduling</li> <li>Operation \u2013 Run checks, monitor status, API reference</li> <li>Troubleshooting \u2013 Solve common issues</li> </ol>"},{"location":"#in-depth-topics","title":"In-Depth Topics","text":"<ul> <li>Architecture Overview \u2013 How components interact, data flow, workflow</li> <li>API Reference (below) \u2013 Function-level documentation for scripting</li> </ul>"},{"location":"#architecture-at-a-glance","title":"Architecture at a Glance","text":"<ul> <li>Host-Side: Bash scripts orchestrating checks, state management, SVG rendering</li> <li>Guest-Side: PowerShell for optional native Windows update automation</li> <li>Integration: Proxmox API via <code>pvesh</code> and <code>qm</code>, QEMU Guest Agent for version queries</li> <li>State: <code>.state</code> files track versions and nag status per VM</li> <li>Notifications: SMTP, MS Graph, or webhook channels for update alerts</li> </ul>"},{"location":"#api-reference","title":"API Reference","text":""},{"location":"#modules","title":"Modules","text":"Module Purpose <code>main.sh</code> Main orchestrator; runs update checks <code>lib/default.sh</code> Version fetching, core update logic <code>lib/pve-interact.sh</code> Proxmox API wrapper <code>lib/state.sh</code> VM state management <code>lib/svg-nag.sh</code> SVG template rendering <code>lib/logger.sh</code> Logging framework <code>lib/notification.sh</code> Notification dispatcher"},{"location":"#key-functions","title":"Key Functions","text":"<p>Version Management:</p> <ul> <li><code>fetch_latest_virtio_version()</code> \u2013 Get latest VirtIO from Fedora</li> <li><code>fetch_latest_qemu_ga_version()</code> \u2013 Get latest QEMU GA from Fedora</li> </ul> <p>VM Interaction:</p> <ul> <li><code>get_windows_vms()</code> \u2013 Discover all Windows VMs</li> <li><code>get_windows_virtio_version(vmid)</code> \u2013 Query installed VirtIO in VM</li> <li><code>get_windows_QEMU_GA_version(vmid)</code> \u2013 Query installed QEMU GA in VM</li> <li><code>update_vm_description_with_update_nag(node, vmid, ...)</code> \u2013 Add SVG banner to VM</li> </ul> <p>State Management:</p> <ul> <li><code>save_vm_state(vmid, v1, v2, nag, genid)</code> \u2013 Persist state</li> <li><code>load_vm_state(vmid)</code> \u2013 Load state from file</li> <li><code>should_show_nag(vmid, ...)</code> \u2013 Decide if nag should display</li> </ul> <p>SVG Rendering:</p> <ul> <li><code>build_svg_virtio_update_nag(vmid, cur, latest, date)</code> \u2013 Create VirtIO nag</li> <li><code>build_svg_qemu_ga_update_nag(vmid, cur, latest, date)</code> \u2013 Create QEMU GA nag</li> <li><code>build_svg_update_nag(vmid, ...)</code> \u2013 Create dual-component nag</li> <li><code>maybe_show_update_nag(node, vmid, need_virtio, need_qemu_ga, virtio_ver, current_virtio, qemu_ver, current_qemu, current_virtio_rel, current_qemu_rel, vmgenid)</code> \u2013 Orchestrate nag creation and state updates</li> </ul> <p>See Operation Guide for detailed function signatures and examples.</p>"},{"location":"#configuration","title":"Configuration","text":"<p>Environment variables in <code>.env</code> control:</p> <ul> <li>Logging (level, format, output)</li> <li>State directory location</li> <li>Notification channels (SMTP, webhook, MS Graph)</li> <li>Scheduling (via cron or systemd timer)</li> </ul> <p>See Configuration Guide for all options and examples.</p>"},{"location":"#support-contribution","title":"Support &amp; Contribution","text":"<ul> <li>Documentation: First, make the necessary changes in the scripts. If the content is static, then make the changes directly in the generator script. Then, run the command <code>./generate-docs.sh</code> to regenerate.</li> <li>Issues: Check Troubleshooting Guide</li> <li>Logs: Enable <code>LOG_LEVEL=debug</code> for verbose output</li> <li>Repository: https://github.com/fs1n/PVE-QEMU-VirtIO-Updater</li> </ul> <p>Last Updated: 2026-02-01 Version: 1.0 License: MIT LICENSE</p>"},{"location":"01-overview/","title":"Architecture Overview","text":""},{"location":"01-overview/#project-purpose","title":"Project Purpose","text":"<p>The PVE-QEMU-VirtIO-Updater is a Proxmox VE automation tool that monitors Windows VMs for outdated VirtIO drivers and QEMU Guest Agent software. When updates are available, it creates visual update notifications (SVG banners) in the Proxmox UI and persists state to avoid duplicate notifications.</p>"},{"location":"01-overview/#core-components","title":"Core Components","text":""},{"location":"01-overview/#host-side-bash","title":"Host-Side (Bash)","text":"<ul> <li>main.sh: Orchestrator; runs update checks, manages VM workflows</li> <li>lib/default.sh: Version fetching from Fedora People Archive, core update logic</li> <li>lib/pve-interact.sh: Proxmox API wrapper (VM discovery, guest version queries)</li> <li>lib/state.sh: Persistent state management for tracking updates per VM</li> <li>lib/svg-nag.sh: SVG template rendering for update banners</li> <li>lib/logger.sh: Centralized logging with syslog/journal support</li> <li>lib/notification.sh: Extensible notification framework (SMTP, Webhook, MS Graph)</li> </ul>"},{"location":"01-overview/#guest-side-powershell","title":"Guest-Side (PowerShell)","text":"<ul> <li>updater-win.ps1: Windows PowerShell script (run inside VMs to download/install updates)</li> </ul>"},{"location":"01-overview/#templates","title":"Templates","text":"<ul> <li>templates/svg/update-nag-template.svg: SVG template for single-component updates</li> <li>templates/svg/update-nag-both-template.svg: SVG template for dual-component updates</li> <li>templates/html/email-template.html: Email notification template</li> </ul>"},{"location":"01-overview/#data-flow-diagram","title":"Data Flow Diagram","text":"<pre><code>graph LR\n    A[\"main.sh&lt;br/&gt;(Cron/Timer)\"] --&gt;|load libs| B[\"lib/default.sh&lt;br/&gt;lib/pve-interact.sh&lt;br/&gt;lib/state.sh&lt;br/&gt;lib/logger.sh\"]\n    A --&gt;|init| C[\"Logging&lt;br/&gt;State Dir\"]\n    A --&gt;|query| D[\"Proxmox API&lt;br/&gt;pvesh/qm\"]\n    D --&gt;|VM list&lt;br/&gt;Windows VMs| E[\"lib/pve-interact.sh&lt;br/&gt;get_windows_vms\"]\n    E --&gt;|guest exec| F[\"Windows VM&lt;br/&gt;QEMU Guest Agent\"]\n    F --&gt;|version info| E\n    E --&gt;|current versions| A\n    A --&gt;|fetch| G[\"Fedora Archive&lt;br/&gt;VirtIO/QEMU GA\"]\n    G --&gt;|latest versions| A\n    A --&gt;|compare versions| H[\"Version Logic\"]\n    H --&gt;|check state| I[\"lib/state.sh&lt;br/&gt;.state files\"]\n    I --&gt;|load history| H\n    H --&gt;|updates needed?| J{\"Show Nag?\"}\n    J --&gt;|yes| K[\"lib/svg-nag.sh&lt;br/&gt;render SVG\"]\n    K --&gt;|write| L[\"/usr/share/pve-manager/images/&lt;br/&gt;update-VMID.svg\"]\n    K --&gt;|link in desc| A\n    A --&gt;|update description| D\n    D --&gt;|UI displays banner| M[\"Proxmox UI&lt;br/&gt;VM Description\"]\n    A --&gt;|persist state| I\n    A --&gt;|notify| N[\"lib/notification.sh&lt;br/&gt;SMTP/Webhook/Graph\"]</code></pre>"},{"location":"01-overview/#update-workflow","title":"Update Workflow","text":"<ol> <li>Initialization: main.sh sources libraries, initializes logging, creates state directory</li> <li>Dependency Check: Verify curl, jq, pvesh, qm, sed, awk are available</li> <li>VM Discovery: Query Proxmox API for all Windows VMs on cluster</li> <li>Version Fetch: Download latest VirtIO and QEMU GA versions from Fedora Archive</li> <li>Per-VM Check:</li> <li>Query guest OS for installed versions via QEMU Guest Agent</li> <li>Compare against latest available</li> <li>Load previous state to detect clones/restores (vmgenid tracking)</li> <li>Nag Decision:</li> <li>If updates available and state changed (or first run): render SVG, update VM description, save new state</li> <li>If VM already up-to-date: remove any existing nag banner</li> <li>Optional Notifications: Send via configured channels (SMTP, MS Graph, Webhook)</li> </ol>"},{"location":"01-overview/#state-management","title":"State Management","text":"<p>Each Windows VM gets a <code>.state</code> file tracking:</p> <ul> <li>VMGENID: Unique VM identifier (for clone detection)</li> <li>VIRTIO_VERSION: Last known VirtIO version</li> <li>QEMU_GA_VERSION: Last known QEMU GA version</li> <li>NAG_ACTIVE: Whether notification is currently displayed</li> <li>LAST_CHECKED: Timestamp of last check</li> </ul> <p>When VM is cloned or restored, vmgenid changes \u2192 state file is cleared \u2192 nag shown again.</p>"},{"location":"01-overview/#configuration","title":"Configuration","text":"<p>Environment variables (from <code>.env</code>):</p> Variable Default Purpose <code>LOG_DIR</code> <code>&lt;script&gt;/logs</code> Log file directory <code>LOG_LEVEL</code> <code>info</code> Logging verbosity (debug/info/notice/warn/error) <code>LOG_FORMAT</code> <code>[%d] [%l] %m</code> Log message format <code>STATE_DIR</code> <code>&lt;script&gt;/.state</code> VM state files directory <code>NOTIFICATION_CHANNELS</code> (empty) Comma-separated: smtp, msgraph, webhook <code>SMTP_SERVER</code> (empty) SMTP host for email notifications <code>WEBHOOK_URL</code> (empty) HTTP endpoint for webhook notifications <code>MSGRAPH_TOKEN</code> (empty) Bearer token for MS Graph API"},{"location":"01-overview/#deployment-model","title":"Deployment Model","text":"<p>Typically deployed as:</p> <ul> <li>Host Setup: Copy scripts to Proxmox node, create <code>.env</code> config, set up cron/systemd timer</li> <li>VM Setup: Optionally copy <code>updater-win.ps1</code> to Windows VMs for automated updates</li> <li>Monitoring: Check logs, adjust LOG_LEVEL as needed, monitor SVG nags in Proxmox UI</li> </ul>"},{"location":"02-installation/","title":"Installation Guide","text":""},{"location":"02-installation/#prerequisites","title":"Prerequisites","text":""},{"location":"02-installation/#host-proxmox-ve","title":"Host (Proxmox VE)","text":"<ul> <li>Proxmox VE 8.4+ with API access</li> <li>External tools:</li> <li><code>jq</code> \u2013 JSON query tool</li> <li><code>curl</code> \u2013 HTTP client</li> <li><code>pvesh</code> \u2013 Proxmox API CLI (included with PVE)</li> <li><code>qm</code> \u2013 QEMU machine manager (included with PVE)</li> <li>Standard Unix tools: <code>sed</code>, <code>awk</code>, <code>grep</code>, <code>date</code></li> </ul>"},{"location":"02-installation/#windows-vms","title":"Windows VMs","text":"<ul> <li>Windows 7 SP1, Server 2008 R2, or newer</li> <li>QEMU Guest Agent installed (for version queries)</li> <li>PowerShell 7+ (optional, for native update script)</li> </ul>"},{"location":"02-installation/#host-installation","title":"Host Installation","text":""},{"location":"02-installation/#1-clone-or-download","title":"1. Clone or Download","text":"<pre><code># Option A: Clone repository\ngit clone https://github.com/fs1n/PVE-QEMU-VirtIO-Updater.git\ncd PVE-QEMU-VirtIO-Updater\n\n# Option B: Extract tar/zip\ntar xzf PVE-QEMU-VirtIO-Updater.tar.gz\ncd PVE-QEMU-VirtIO-Updater\n</code></pre>"},{"location":"02-installation/#2-verify-dependencies","title":"2. Verify Dependencies","text":"<pre><code># Install missing packages on Debian/Ubuntu-based Proxmox\napt update\napt install -y jq curl\n\n# Verify tools are available\nfor tool in jq curl pvesh qm sed awk grep; do\n  command -v \"$tool\" &gt; /dev/null || echo \"Missing: $tool\"\ndone\n</code></pre>"},{"location":"02-installation/#3-create-configuration","title":"3. Create Configuration","text":"<pre><code># Copy environment template\ncp .env.example .env\n\n# Edit with your settings\nnano .env\n# Configure LOG_DIR, LOG_LEVEL, STATE_DIR, NOTIFICATION_CHANNELS as needed\n</code></pre>"},{"location":"02-installation/#4-set-permissions","title":"4. Set Permissions","text":"<pre><code># Make scripts executable\nchmod +x main.sh update.sh generate-docs.sh\nchmod +x lib/*.sh\n</code></pre>"},{"location":"02-installation/#5-verify-execution","title":"5. Verify Execution","text":"<pre><code># Test running the script (dry-run mode, no state changes)\n./main.sh --help 2&gt;&amp;1 || ./main.sh 2&gt;&amp;1 | head -20\n</code></pre>"},{"location":"02-installation/#windows-vm-setup-optional","title":"Windows VM Setup (Optional)","text":"<p>If you want Windows VMs to auto-apply updates:</p>"},{"location":"02-installation/#1-copy-powershell-script","title":"1. Copy PowerShell Script","text":"<pre><code># On Windows VM, as Administrator:\nCopy-Item updater-win.ps1 C:\\scripts\\\nSet-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser\n</code></pre>"},{"location":"02-installation/#2-schedule-updates","title":"2. Schedule Updates","text":"<pre><code># Create scheduled task (monthly, e.g., first Sunday)\n$trigger = New-ScheduledTaskTrigger -Weekly -DaysOfWeek Sunday -At 2am\n$action = New-ScheduledTaskAction -Execute \"powershell.exe\" `\n  -Argument \"-File C:\\scripts\\updater-win.ps1\"\nRegister-ScheduledTask -TaskName \"VirtIO Driver Update\" -Trigger $trigger `\n  -Action $action -User \"SYSTEM\" -RunLevel Highest\n</code></pre>"},{"location":"02-installation/#automated-scheduling-host","title":"Automated Scheduling (Host)","text":""},{"location":"02-installation/#option-a-cron-runs-every-4-hours","title":"Option A: Cron (runs every 4 hours)","text":"<pre><code># Edit crontab\ncrontab -e\n\n# Add line:\n0 */4 * * * /path/to/PVE-QEMU-VirtIO-Updater/main.sh &gt;&gt; /var/log/pve-virtio-updater.log 2&gt;&amp;1\n</code></pre>"},{"location":"02-installation/#option-b-systemd-timer","title":"Option B: Systemd Timer","text":"<pre><code># Create /etc/systemd/system/pve-virtio-updater.service\n[Unit]\nDescription=PVE QEMU VirtIO Updater\nAfter=network-online.target\n\n[Service]\nType=oneshot\nExecStart=/path/to/PVE-QEMU-VirtIO-Updater/main.sh\nStandardOutput=journal\nStandardError=journal\nSyslogIdentifier=pve-virtio-updater\n\n# Create /etc/systemd/system/pve-virtio-updater.timer\n[Unit]\nDescription=Run PVE VirtIO Updater every 4 hours\nRequires=pve-virtio-updater.service\n\n[Timer]\nOnBootSec=5min\nOnUnitActiveSec=4h\nAccuracySec=1min\n\n[Install]\nWantedBy=timers.target\n\n# Enable and start\nsudo systemctl daemon-reload\nsudo systemctl enable pve-virtio-updater.timer\nsudo systemctl start pve-virtio-updater.timer\nsudo systemctl status pve-virtio-updater.timer\n</code></pre>"},{"location":"02-installation/#verification","title":"Verification","text":"<pre><code># Check logs\ntail -f logs/proxmox_virtio_updater.log\n\n# Verify state tracking\nls -la .state/\n\n# Check SVG nags (should be in /usr/share/pve-manager/images/update-*.svg)\nls -la /usr/share/pve-manager/images/update-*.svg 2&gt;/dev/null || echo \"No nags created yet\"\n</code></pre>"},{"location":"03-configuration/","title":"Configuration Guide","text":""},{"location":"03-configuration/#environment-variables","title":"Environment Variables","text":"<p>All configuration is done via <code>.env</code> file in the script directory. Copy <code>.env.example</code> to <code>.env</code> and customize:</p> <pre><code>cp .env.example .env\n</code></pre>"},{"location":"03-configuration/#logging-configuration","title":"Logging Configuration","text":"<pre><code># Directory where log files will be stored (default: &lt;script_dir&gt;/logs)\nLOG_DIR=/var/log/pve-virtio-updater\n\n# Logging level: debug, info, notice, warn, error, critical, alert, emergency\n# Default: info\nLOG_LEVEL=info\n\n# Log message format\n# Available variables:\n#   %d = date and time (YYYY-MM-DD HH:MM:SS)\n#   %z = timezone (UTC or LOCAL)\n#   %l = log level name (DEBUG, INFO, WARN, ERROR, etc.)\n#   %s = script name\n#   %m = message\n# Default: [%d] [%l] %m\nLOG_FORMAT=\"[%d] [%l] %m\"\n\n# Use UTC timestamps instead of local time\nLOG_USE_UTC=false\n\n# Send logs to systemd journal\nLOG_JOURNAL=true\n\n# Tag for journal entries\nLOG_JOURNAL_TAG=\"PVE-VirtIO-Updater\"\n</code></pre>"},{"location":"03-configuration/#state-management","title":"State Management","text":"<pre><code># Directory to store VM state files (default: &lt;script_dir&gt;/.state)\n# Each running VM gets a file: vm-{VMID}.state\nSTATE_DIR=/var/lib/pve-virtio-updater/.state\n</code></pre>"},{"location":"03-configuration/#svg-template-configuration","title":"SVG Template Configuration","text":"<pre><code># Path to the SVG template files (default: &lt;script_dir&gt;/templates/svg)\nSVG_TEMPLATE_DIR=/usr/local/share/pve-virtio-updater/templates/svg\n\n# Path where generated SVG nags are stored (default: /usr/share/pve-manager/images/)\nSVG_IMAGE_PATH=/usr/share/pve-manager/images/\n</code></pre>"},{"location":"03-configuration/#notification-configuration","title":"Notification Configuration","text":"<pre><code># Comma-separated list of enabled notification channels\n# Available: smtp, msgraph, webhook\nNOTIFICATION_CHANNELS=smtp,webhook\n\n# SMTP Configuration\nSMTP_SERVER=mail.example.com\nSMTP_PORT=587\nSMTP_USE_TLS=true\nSMTP_USERNAME=updater@example.com\nSMTP_PASSWORD=secretpassword\nSMTP_FROM=updater@example.com\nSMTP_TO=admins@example.com\n\n# Microsoft Graph Configuration (for MS Entra / O365)\nMSGRAPH_TENANT_ID=your-tenant-id\nMSGRAPH_CLIENT_ID=your-client-id\nMSGRAPH_CLIENT_SECRET=your-client-secret\nMSGRAPH_FROM=updater@example.com\nMSGRAPH_TO=admins@example.com\n\n# Webhook Configuration\nWEBHOOK_URL=https://hooks.example.com/notify\nWEBHOOK_METHOD=POST\nWEBHOOK_AUTH_HEADER=Authorization: Bearer your-token-here\n</code></pre>"},{"location":"03-configuration/#configuration-examples","title":"Configuration Examples","text":""},{"location":"03-configuration/#example-1-basic-setup-logging-only","title":"Example 1: Basic Setup (Logging Only)","text":"<pre><code># .env\nLOG_DIR=/var/log/pve-virtio-updater\nLOG_LEVEL=info\nSTATE_DIR=/var/lib/pve-virtio-updater/.state\n# Notifications disabled\nNOTIFICATION_CHANNELS=\n</code></pre>"},{"location":"03-configuration/#example-2-with-email-notifications","title":"Example 2: With Email Notifications","text":"<pre><code># .env\nLOG_LEVEL=info\nNOTIFICATION_CHANNELS=smtp\nSMTP_SERVER=mail.corp.local\nSMTP_FROM=pve-alerts@corp.local\nSMTP_TO=platform-team@corp.local\n</code></pre>"},{"location":"03-configuration/#example-3-with-slack-webhook","title":"Example 3: With Slack Webhook","text":"<pre><code># .env\nLOG_LEVEL=info\nNOTIFICATION_CHANNELS=webhook\nWEBHOOK_URL=https://hooks.slack.com/services/YOUR/WEBHOOK/URL\n</code></pre>"},{"location":"03-configuration/#example-4-multi-channel-email-webhook","title":"Example 4: Multi-Channel (Email + Webhook)","text":"<pre><code># .env\nLOG_LEVEL=debug\nNOTIFICATION_CHANNELS=smtp,webhook\nSMTP_SERVER=mail.example.com\nSMTP_FROM=updates@example.com\nSMTP_TO=ops@example.com\nWEBHOOK_URL=https://teams.microsoft.com/webhookb2/...\n</code></pre>"},{"location":"03-configuration/#file-locations","title":"File Locations","text":"<pre><code>/path/to/PVE-QEMU-VirtIO-Updater/\n\u251c\u2500\u2500 .env                              # Your configuration (git-ignored)\n\u251c\u2500\u2500 .env.example                      # Configuration template\n\u251c\u2500\u2500 main.sh                           # Main entry point\n\u251c\u2500\u2500 update.sh                         # Self-update script\n\u251c\u2500\u2500 lib/\n\u2502   \u251c\u2500\u2500 default.sh                   # Core logic\n\u2502   \u251c\u2500\u2500 logger.sh                    # Logging module\n\u2502   \u251c\u2500\u2500 notification.sh              # Notifications\n\u2502   \u251c\u2500\u2500 pve-interact.sh              # Proxmox API wrapper\n\u2502   \u251c\u2500\u2500 state.sh                     # State management\n\u2502   \u2514\u2500\u2500 svg-nag.sh                   # SVG rendering\n\u251c\u2500\u2500 templates/\n\u2502   \u251c\u2500\u2500 html/email-template.html\n\u2502   \u2514\u2500\u2500 svg/\n\u2502       \u251c\u2500\u2500 update-nag-template.svg\n\u2502       \u2514\u2500\u2500 update-nag-both-template.svg\n\u251c\u2500\u2500 logs/                            # Log files (created at runtime)\n\u2502   \u2514\u2500\u2500 proxmox_virtio_updater.log\n\u2514\u2500\u2500 .state/                          # VM state tracking (created at runtime)\n    \u251c\u2500\u2500 vm-100.state\n    \u251c\u2500\u2500 vm-101.state\n    \u2514\u2500\u2500 ...\n</code></pre>"},{"location":"03-configuration/#best-practices","title":"Best Practices","text":"<ol> <li> <p>Log Rotation: Use logrotate for production deployments    <pre><code># /etc/logrotate.d/pve-virtio-updater\n/var/log/pve-virtio-updater/*.log {\n  daily\n  rotate 7\n  compress\n  delaycompress\n  notifempty\n}\n</code></pre></p> </li> <li> <p>Restrictive Permissions: Protect state and logs    <pre><code>chmod 700 /var/lib/pve-virtio-updater/.state\nchmod 700 /var/log/pve-virtio-updater\n</code></pre></p> </li> <li> <p>Monitor via Journal: With systemd timer    <pre><code>journalctl -u pve-virtio-updater.timer -u pve-virtio-updater.service -f\n</code></pre></p> </li> </ol>"},{"location":"04-operation/","title":"Operation Guide","text":""},{"location":"04-operation/#running-the-updater","title":"Running the Updater","text":""},{"location":"04-operation/#manual-execution","title":"Manual Execution","text":"<pre><code># Run update check immediately\n/path/to/PVE-QEMU-VirtIO-Updater/main.sh\n\n# With verbose logging\nLOG_LEVEL=debug /path/to/PVE-QEMU-VirtIO-Updater/main.sh\n</code></pre>"},{"location":"04-operation/#via-systemd-timer","title":"Via Systemd Timer","text":"<pre><code># Check timer status\nsudo systemctl status pve-virtio-updater.timer\n\n# View last run\nsudo systemctl status pve-virtio-updater.service\n\n# Check logs\nsudo journalctl -u pve-virtio-updater.service -n 50\n\n# Manually trigger (don't wait for timer)\nsudo systemctl start pve-virtio-updater.service\n\n# View real-time logs\nsudo journalctl -u pve-virtio-updater.service -f\n</code></pre>"},{"location":"04-operation/#via-cron","title":"Via Cron","text":"<pre><code># View cron job\ncrontab -l\n\n# Manually test\n/path/to/PVE-QEMU-VirtIO-Updater/main.sh\n\n# Check result\ntail -f /var/log/pve-virtio-updater.log\n</code></pre>"},{"location":"04-operation/#monitoring","title":"Monitoring","text":""},{"location":"04-operation/#check-logs","title":"Check Logs","text":"<pre><code># Recent entries\ntail -f logs/proxmox_virtio_updater.log\n\n# Filter by level\ngrep \"ERROR\\|WARN\" logs/proxmox_virtio_updater.log\n\n# Search for VM activity\ngrep \"VM 100\" logs/proxmox_virtio_updater.log\n</code></pre>"},{"location":"04-operation/#verify-state","title":"Verify State","text":"<pre><code># List tracked VMs\nls -lah .state/vm-*.state\n\n# View VM 100 state\ncat .state/vm-100.state\n\n# Check update status\ncat .state/vm-100.state | grep NAG_ACTIVE\n</code></pre>"},{"location":"04-operation/#verify-svg-nags","title":"Verify SVG Nags","text":"<pre><code># List created SVG nags\nls -lah /usr/share/pve-manager/images/update-*.svg\n\n# View in Proxmox UI\n# Navigate to: Datacenter \u2192 Nodes \u2192 [Node] \u2192 VM [ID] \u2192 Summary \u2192 Description\n# Should show banner with versions\n</code></pre>"},{"location":"04-operation/#api-reference","title":"API Reference","text":""},{"location":"04-operation/#core-functions","title":"Core Functions","text":""},{"location":"04-operation/#check_script_dependencies","title":"check_script_dependencies()","text":"<p>Validates that all required external tools are installed.</p> <p>Usage: <pre><code>source lib/default.sh\ncheck_script_dependencies\n</code></pre></p> <p>Returns: 0 if all deps found, 1 if missing</p>"},{"location":"04-operation/#fetch_latest_virtio_version","title":"fetch_latest_virtio_version()","text":"<p>Fetches latest VirtIO driver version from Fedora People Archive.</p> <p>Usage: <pre><code>version_json=$(fetch_latest_virtio_version)\nlatest_ver=$(echo \"$version_json\" | jq -r '.version')\nrelease_date=$(echo \"$version_json\" | jq -r '.release')\n</code></pre></p> <p>Output (JSON): <pre><code>{\"version\":\"0.1.285\",\"release\":\"2025-01-15\"}\n</code></pre></p>"},{"location":"04-operation/#fetch_latest_qemu_ga_version","title":"fetch_latest_qemu_ga_version()","text":"<p>Fetches latest QEMU Guest Agent version from Fedora People Archive.</p> <p>Usage: <pre><code>qemu_json=$(fetch_latest_qemu_ga_version)\nlatest_qemu=$(echo \"$qemu_json\" | jq -r '.version')\n</code></pre></p>"},{"location":"04-operation/#get_windows_vms","title":"get_windows_vms()","text":"<p>Queries all Windows VMs running on the Proxmox cluster.</p> <p>Usage: <pre><code>source lib/pve-interact.sh\nwindows_vms=$(get_windows_vms)\necho \"$windows_vms\" | jq '.' # Pretty-print VM list\n</code></pre></p> <p>Output (JSON): <pre><code>{\n  \"100\": {\n    \"node\": \"pve-node1\",\n    \"name\": \"win10-vm\",\n    \"ostype\": \"win10\",\n    \"status\": \"running\",\n    \"vmgenid\": \"uuid-value\"\n  }\n}\n</code></pre></p>"},{"location":"04-operation/#get_windows_virtio_versionvmid","title":"get_windows_virtio_version(vmid)","text":"<p>Query VirtIO driver version inside Windows VM.</p> <p>Usage: <pre><code>virtio_ver=$(get_windows_virtio_version 100)\necho \"Current VirtIO: $virtio_ver\"\n</code></pre></p> <p>Returns: Version string (e.g., \"0.1.283\") or empty if not found</p>"},{"location":"04-operation/#get_windows_qemu_ga_versionvmid","title":"get_windows_QEMU_GA_version(vmid)","text":"<p>Query QEMU Guest Agent version inside Windows VM.</p> <p>Usage: <pre><code>qemu_ver=$(get_windows_QEMU_GA_version 100)\necho \"Current QEMU GA: $qemu_ver\"\n</code></pre></p>"},{"location":"04-operation/#save_vm_statevmid-virtio_ver-qemu_ga_ver-nag_shown-vmgenid","title":"save_vm_state(vmid, virtio_ver, qemu_ga_ver, nag_shown, vmgenid)","text":"<p>Persist VM update state to file.</p> <p>Usage: <pre><code>source lib/state.sh\nsave_vm_state 100 \"0.1.283\" \"9.0.0\" \"true\" \"uuid-value\"\n</code></pre></p>"},{"location":"04-operation/#load_vm_statevmid","title":"load_vm_state(vmid)","text":"<p>Load VM state from file into environment variables.</p> <p>Usage: <pre><code>load_vm_state 100\necho \"Stored VirtIO: $STORED_VIRTIO_VERSION\"\necho \"Stored QEMU GA: $STORED_QEMU_GA_VERSION\"\necho \"Nag Active: $STORED_NAG_ACTIVE\"\n</code></pre></p>"},{"location":"04-operation/#should_show_nagvmid-current_virtio-latest_virtio-current_qemu_ga-latest_qemu_ga-vmgenid","title":"should_show_nag(vmid, current_virtio, latest_virtio, current_qemu_ga, latest_qemu_ga, vmgenid)","text":"<p>Determine if update notification should be displayed.</p> <p>Usage: <pre><code>should_show_nag 100 \"0.1.283\" \"0.1.285\" \"9.0.0\" \"9.1.0\" \"$vmgenid\"\ncase $? in\n  0) echo \"Show nag\" ;;\n  1) echo \"Nag muted\" ;;\n  2) echo \"Remove nag (up to date)\" ;;\nesac\n</code></pre></p> <p>Returns: 0=show, 1=mute, 2=remove</p>"},{"location":"04-operation/#build_svg_virtio_update_nagvmid-current-latest-date","title":"build_svg_virtio_update_nag(vmid, current, latest, date)","text":"<p>Generate SVG banner for VirtIO updates.</p> <p>Usage: <pre><code>source lib/svg-nag.sh\nbuild_svg_virtio_update_nag 100 \"0.1.283\" \"0.1.285\" \"2025-01-15\"\n# Creates: /usr/share/pve-manager/images/update-100.svg\n</code></pre></p>"},{"location":"04-operation/#troubleshooting","title":"Troubleshooting","text":"<p>See Troubleshooting Guide.</p>"},{"location":"05-troubleshooting/","title":"Troubleshooting Guide","text":""},{"location":"05-troubleshooting/#common-issues","title":"Common Issues","text":""},{"location":"05-troubleshooting/#jq-is-not-installed","title":"\"jq is not installed\"","text":"<p>Error: <pre><code>[ERROR] Error: jq is not installed.\n</code></pre></p> <p>Solution: <pre><code># Debian/Ubuntu\napt install -y jq\n\n# RHEL/CentOS\nyum install -y jq\n\n# Verify\ncommand -v jq\n</code></pre></p>"},{"location":"05-troubleshooting/#pvesh-command-not-found","title":"\"pvesh: command not found\"","text":"<p>Error: <pre><code>[ERROR] Error: pvesh is not installed.\n</code></pre></p> <p>Solution: <code>pvesh</code> is part of Proxmox VE. Ensure you're running on a Proxmox VE host (not a standalone system). If running in a container, ensure you have API access.</p>"},{"location":"05-troubleshooting/#permission-denied-on-state-directory","title":"\"Permission denied\" on state directory","text":"<p>Error: <pre><code>Failed to create state directory: /var/lib/pve-virtio-updater/.state\n</code></pre></p> <p>Solution: <pre><code># Fix permissions\nsudo mkdir -p /var/lib/pve-virtio-updater/.state\nsudo chown root:root /var/lib/pve-virtio-updater\nsudo chmod 755 /var/lib/pve-virtio-updater\n</code></pre></p>"},{"location":"05-troubleshooting/#no-windows-vms-found","title":"No Windows VMs found","text":"<p>Error: <pre><code>[INFO] No Windows VMs found on this Proxmox host. Exiting.\n</code></pre></p> <p>Cause: Could be normal if no Windows VMs exist or all are stopped.</p> <p>Check: <pre><code># List all VMs\npvesh get /nodes/$(hostname)/qemu --output-format json | jq '.[] | {vmid, name, ostype}'\n\n# List only Windows VMs\npvesh get /nodes/$(hostname)/qemu --output-format json | jq '.[] | select(.ostype | startswith(\"w\"))'\n</code></pre></p>"},{"location":"05-troubleshooting/#failed-to-fetch-fedora-people-archive-page","title":"\"Failed to fetch Fedora People Archive page\"","text":"<p>Error: <pre><code>[ERROR] Failed to access Fedora People Archive. HTTP Status: 403\n</code></pre></p> <p>Cause: Network issue or Fedora servers temporarily down.</p> <p>Solution: <pre><code># Test connectivity\ncurl -I https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/\n\n# Check proxy/firewall\n# If behind proxy, set HTTP_PROXY / HTTPS_PROXY environment variables\n</code></pre></p>"},{"location":"05-troubleshooting/#qemu-guest-agent-not-responding","title":"QEMU Guest Agent not responding","text":"<p>Error: <pre><code>qm guest exec: error (500)\n</code></pre></p> <p>Cause: QEMU Guest Agent not installed in Windows VM or VM not responding.</p> <p>Solution: <pre><code># On Windows VM (as Administrator):\n# Install QEMU Guest Agent\n# Download from: https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/latest-qemu-ga/\n\n# Or via Chocolatey:\nchoco install qemu-guest-agent\n\n# Verify service is running:\nGet-Service -Name QEMU-GA* | Select-Object Status\n</code></pre></p>"},{"location":"05-troubleshooting/#svg-nags-not-showing-in-proxmox-ui","title":"SVG nags not showing in Proxmox UI","text":"<p>Cause 1: SVG not created <pre><code># Check if SVG exists\nls -la /usr/share/pve-manager/images/update-*.svg\n</code></pre></p> <p>Cause 2: SVG created but not linked in VM description <pre><code># Check VM description\npvesh get /nodes/pve/qemu/100/config | jq '.description'\n\n# Manually add (if needed)\nqm set 100 -description '&lt;img src=\"/pve2/images/update-100.svg\" alt=\"Update\" /&gt;'\n</code></pre></p> <p>Cause 3: PVE UI caching - Clear browser cache (Ctrl+Shift+Delete) - Hard refresh Proxmox page (Ctrl+F5)</p>"},{"location":"05-troubleshooting/#state-file-corruption","title":"State file corruption","text":"<p>Error: <pre><code>[WARN] Unknown key in state file: ...\n</code></pre></p> <p>Solution: <pre><code># Backup and remove the corrupted state file\ncp .state/vm-100.state .state/vm-100.state.bak\nrm .state/vm-100.state\n\n# Next run will recreate it\n./main.sh\n</code></pre></p>"},{"location":"05-troubleshooting/#debug-mode","title":"Debug Mode","text":"<p>Enable verbose logging:</p> <pre><code># Via command line\nLOG_LEVEL=debug ./main.sh\n\n# Via cron\n0 */4 * * * LOG_LEVEL=debug /path/to/main.sh &gt;&gt; /var/log/pve-virtio-updater-debug.log 2&gt;&amp;1\n</code></pre>"},{"location":"05-troubleshooting/#getting-help","title":"Getting Help","text":"<ol> <li> <p>Check logs for specific error messages:    <pre><code>tail -100 logs/proxmox_virtio_updater.log | grep -i error\n</code></pre></p> </li> <li> <p>Verify dependencies:    <pre><code>bash -c 'for t in jq curl pvesh qm sed awk grep; do command -v $t || echo \"Missing: $t\"; done'\n</code></pre></p> </li> <li> <p>Test manually:    <pre><code># Test Fedora archive access\ncurl -s https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/ | grep virtio-win | head -3\n\n# Test VM queries\npvesh get /nodes/$(hostname)/qemu --output-format json | jq '.[0]'\n\n# Test guest agent\nqm guest exec 100 -- echo \"Agent works\"\n</code></pre></p> </li> <li> <p>Report issues with:</p> </li> <li>Full error output from logs</li> <li>Output of <code>check_script_dependencies</code></li> <li>Proxmox version: <code>pvesh get /version</code></li> <li>Windows VM info: <code>qm status &lt;vmid&gt;</code></li> </ol>"}]}